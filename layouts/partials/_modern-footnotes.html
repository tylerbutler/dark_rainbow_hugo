<!-- MODERN FOOTNOTES with Littlefoot.js -->
<!-- Modern, accessible, jQuery-free footnote implementation -->

<!-- Use local/bundled version (no CDN dependencies) -->
<link rel="stylesheet" href="{{ "css/littlefoot.css" | relURL }}">
<script src="{{ "js/littlefoot.js" | relURL }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Littlefoot with enhanced configuration
    const footnotes = littlefoot.littlefoot({
      // Core behavior (matching Bigfoot.js settings)
      deleteOnUnhover: false,
      preventPageScroll: false,
      hoverDelay: 250,
      allowMultiple: false,
      
      // Modern enhancements
      activateOnHover: true,
      allowDuplicates: false,
      dismissOnUnhover: false,
      dismissDelay: 100,
      
      // Accessibility
      scope: 'main, article',
      anchorPattern: /(fn|footnote|note)[:\-_\d]/gi,
      anchorParentSelector: 'sup',
      
      // Button configuration
      buttonTemplate: `
        <button 
          class="littlefoot__button" 
          id="<% reference %>" 
          title="See footnote"
          aria-describedby="fncontent:<% number %>"
          aria-expanded="false"
          aria-label="Footnote <% number %>"
          type="button"
        >
          <% number %>
        </button>
      `,
      
      // Content template with better semantics
      contentTemplate: `
        <aside 
          class="littlefoot__footnote" 
          id="fncontent:<% id %>"
          role="dialog"
          aria-label="Footnote <% number %>"
          tabindex="-1"
        >
          <div class="littlefoot__wrapper">
            <div class="littlefoot__content">
              <% content %>
            </div>
            <button 
              class="littlefoot__close" 
              type="button" 
              aria-label="Close footnote"
              title="Close footnote"
            >
              Ã—
            </button>
          </div>
          <div class="littlefoot__tooltip"></div>
        </aside>
      `,
      
      // Callbacks for enhanced functionality
      activateCallback: function(popover, button) {
        // Focus management for accessibility
        popover.focus();
        
        // Analytics tracking (if needed)
        if (typeof gtag !== 'undefined') {
          gtag('event', 'footnote_view', {
            'footnote_number': button.textContent
          });
        }
      },
      
      dismissCallback: function(popover, button) {
        // Return focus to button for accessibility
        button.focus();
      }
    });
    
    // Store reference for potential cleanup
    window.modernFootnotes = footnotes;
    
    // Enhanced keyboard support
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        footnotes.dismissAll();
      }
    });
  });
</script>

<!-- Modern CSS styling using our design system -->
<style>
  /* Littlefoot button styling with CSS custom properties */
  .littlefoot__button {
    background: var(--color-orange) !important;
    color: var(--color-bg) !important;
    border: none !important;
    border-radius: 50% !important;
    font-family: var(--font-family-main) !important;
    font-weight: 600 !important;
    font-size: 0.8em !important;
    width: 1.2em !important;
    height: 1.2em !important;
    line-height: 1 !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
    vertical-align: baseline !important;
    position: relative !important;
    top: -0.3em !important;
    margin: 0 0.1em !important;
  }
  
  .littlefoot__button:hover,
  .littlefoot__button:focus-visible,
  .littlefoot__button--active {
    background: var(--color-orange-dark) !important;
    transform: scale(1.1) !important;
  }
  
  .littlefoot__button:focus-visible {
    outline: 2px solid var(--color-orange) !important;
    outline-offset: 2px !important;
  }
  
  /* Popover styling */
  .littlefoot__footnote {
    background: var(--color-bg-accent) !important;
    border: 1px solid var(--color-purple) !important;
    border-radius: var(--border-radius-md) !important;
    box-shadow: 
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06),
      0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
    max-width: 320px !important;
    font-family: var(--font-family-main) !important;
    z-index: var(--z-tooltip) !important;
  }
  
  .littlefoot__wrapper {
    position: relative !important;
  }
  
  .littlefoot__content {
    padding: var(--space-md) !important;
    color: var(--color-blue) !important;
    font-size: var(--font-size-small) !important;
    line-height: var(--line-height-relaxed) !important;
    max-height: 300px !important;
    overflow-y: auto !important;
  }
  
  .littlefoot__content p {
    margin: 0 0 var(--space-sm) 0 !important;
  }
  
  .littlefoot__content p:last-child {
    margin-bottom: 0 !important;
  }
  
  .littlefoot__content a {
    color: var(--color-green) !important;
    text-decoration-color: color-mix(in srgb, var(--color-green) 50%, transparent) !important;
  }
  
  .littlefoot__content a:hover {
    color: var(--color-orange) !important;
    text-decoration-color: var(--color-orange) !important;
  }
  
  .littlefoot__content code {
    background: var(--color-bg) !important;
    padding: var(--space-xs) var(--space-sm) !important;
    border-radius: var(--border-radius-sm) !important;
    font-family: var(--font-family-mono) !important;
  }
  
  /* Close button */
  .littlefoot__close {
    position: absolute !important;
    top: var(--space-sm) !important;
    right: var(--space-sm) !important;
    background: none !important;
    border: none !important;
    color: var(--color-light) !important;
    font-size: 1.2em !important;
    line-height: 1 !important;
    cursor: pointer !important;
    padding: var(--space-xs) !important;
    border-radius: var(--border-radius-sm) !important;
    transition: all 0.2s ease !important;
  }
  
  .littlefoot__close:hover,
  .littlefoot__close:focus-visible {
    background: var(--color-bg) !important;
    color: var(--color-blue) !important;
    outline: 2px solid var(--color-orange) !important;
    outline-offset: 1px !important;
  }
  
  /* Tooltip styling */
  .littlefoot__tooltip {
    border-color: var(--color-bg-accent) transparent !important;
  }
  
  /* Responsive design */
  @media (max-width: 640px) {
    .littlefoot__footnote {
      max-width: calc(100vw - 2rem) !important;
      margin: 0 1rem !important;
    }
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .littlefoot__button {
      border: 2px solid var(--color-bg) !important;
    }
    
    .littlefoot__footnote {
      border: 2px solid var(--color-blue) !important;
    }
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .littlefoot__button {
      transition: background-color 0.1s !important;
    }
    
    .littlefoot__button:hover {
      transform: none !important;
    }
  }
  
  /* Print styles */
  @media print {
    .littlefoot__button {
      display: none !important;
    }
    
    .littlefoot__footnote {
      display: none !important;
    }
  }
</style>